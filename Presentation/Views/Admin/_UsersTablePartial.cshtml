@model IEnumerable<Core.User>

@if (Model != null && Model.Any())
{
    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <th>#</th>
            <th>ID</th>
            <th>Email</th>
            <th>Login</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        @{
            int counter = 1;
        }
        @foreach (var user in Model)
        {
            <tr>
                <td>@counter</td>
                <td>@user.Id</td>
                <td>@user.Email</td>
                <td>@user.Login</td>
                <td>
                    <select class="form-select form-select-sm group-select" style="width: 150px; display: inline-block;">
                        <option value="">Выберите группу</option>
                    </select>
                    <button class="btn btn-sm btn-primary action-btn"
                            onclick="addToGroup(this, '@user.Id')">
                        Добавить
                    </button>
                </td>
            </tr>
            counter++;
        }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-warning">Нет пользователей для отображения</div>
}

<script>
    // При загрузке частичного представления снова инициализируем группы
    $(document).ready(function() {
        loadGroups();
    });

    function loadGroups() {
        $.get('/Admin/GetAllGroups', function(groups) {
            $('.group-select').each(function() {
                $(this).empty();
                $(this).append('<option value="">Выберите группу</option>');
                groups.forEach(function(group) {
                    $(this).append(`<option value="${group.id}">${group.name}</option>`);
                }.bind(this));
            });
        });
    }

    function addToGroup(button, userId) {
        const groupSelect = $(button).siblings('.group-select');
        const groupId = groupSelect.val();

        if (!groupId) {
            alert('Пожалуйста, выберите группу');
            return;
        }

        if (confirm('Вы уверены, что хотите добавить этого пользователя в группу?')) {
            $.post('/Admin/AddToGroup', {
                userId: userId,
                groupId: groupId
            }, function(response) {
                alert(response.message);
            }).fail(function() {
                alert('Ошибка при добавлении пользователя в группу');
            });
        }
    }
</script>